
<!DOCTYPE html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title> Heidi Xiang's Portoflio</title>

    <link rel="stylesheet" type="text/css" href="/stylesheets/sideBar.css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/font-awesome-ie7.min.css"/>
    <link rel="stylesheet" type="text/css" href="/stylesheets/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="/stylesheets/generalTemplate.css" />
    
  </head>


  <body>
    <div id="st-container" class="st-container">

      <div class="st-pusher">
        <nav class="st-menu st-effect-3" id="menu-3">
          <h2 >Index</h2>

          <ul class = 'MenuList'>
            <li class = 'MenuElement'> 
              <a class="reference" id = "i-home" href="/index.html">
                <i class="icon icon-home"></i> Home
              </a>  
            </li>


            <li class = 'MenuElement'> 
              <a class="reference" id = "i-blog" href = "/techblog.html">
                <i class="icon icon-pencil"></i> Blog
              </a> 
            </li>

            <li class = 'MenuElement'> 
              <a class="reference" id = "i-about" href="/about.html"> 
                <i class="icon icon-plus"></i> About
              </a> 
            </li>

          </ul>
        </nav>  

        <div class="st-content"><!-- this is the wrapper for the content -->
          <div class="st-content-inner">

            <div id="st-trigger-effects" class="button_column">
              <button data-effect="st-effect-3"><i class="icon icon-reorder"></i></button>
            </div> 

            <!-- **************************   header  ****************************** -->
            <header id = "pfl-header">
              <img id = "logo" src = "/../images/bloglogo.png" alt= "logo">

              <div id = "headline">
                <a class = "navbar" href = "/index.html"> <span id = "home"> Home </span></a>
                <a class = "navbar" href = "/techblog.html"> <span id = "blog"> Blog </span></a>
                <a class = "navbar" href = "/about.html"> <span id = "about"> About </span></a>
              </div>
            </header>
            <!-- **************************   header  ****************************** -->

            
            <link rel="stylesheet" type="text/css" href="/../stylesheets/article.css" />
<link rel="stylesheet" type="text/css" href="/../stylesheets/pygments.css" />
<style>
  #blog{
    font-weight: bold;
    text-transform: uppercase;
    color: rgb(255, 255, 255);
    font-size: 20px;
    border-bottom: 2px solid rgb(105,105,105);
  }
  #blog:hover{
    font-size: 22px;
  }

  #i-blog{
    background-color: rgba(63,148,221, 0.7);
  }

</style>


  <div id = "blog-section">

    <section id = "blog_content">
      <article class = "blog_article">
        <header class = "article_header">
          <h2 class = "ah"> python3 urllib</h2>
          <time> 28 November 2015 </time>
        </header>
        <div class = "article_content">
          <h1 id="python3-urllib">python3 urllib</h1>

<h2 id="section">写在前面</h2>

<hr />

<p>之前写了篇总结HTTP协议的文章，今天来总结pyhton3的urllib库，我只挑了些我已经用到的来介绍。实习boss要求项目用python3，所以开始了python3的学习。而网上大多都是python2的教程，所以我就艰难的从官方文档开始学习了。这篇文章有点官方文档译文的性质。话说，虽然已经考过了托福和GRE，怎么感觉看个英文文档还是这么吃力呢……</p>

<h2 id="urllib-url-handling-modules">urllib －－URL handling modules</h2>

<hr />

<p>urllib 中有一共有四个操作URLs的模块：</p>

<ul>
  <li>urllib.request 用来打开和读取URLs</li>
  <li>urllib.error 处理从 urllib.request 出现的异常</li>
  <li>urllib.parse 分析URLs</li>
  <li>urllib.robotparser </li>
</ul>

<p>下面分别介绍每个模块</p>

<h2 id="urllibrequest">urllib.request</h2>

<hr />

<p>官方文档链接：
<a href="https://docs.python.org/3/library/urllib.request.html">https://docs.python.org/3/library/urllib.request.html</a></p>

<p>在python中引用这个模块的方法是：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">urllib.request</span></code></pre></div>

<p>urllib.request 模块中定义了很多用来打开URLs的函数和类，我只挑了些我已经用到的来介绍。</p>

<h3 id="urllibrequesturlopen">urllib.request.urlopen()</h3>

<hr />

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="p">[</span><span class="n">timeout</span><span class="p">,]</span><span class="o">*</span><span class="p">,</span> <span class="n">cafile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">capath</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cadefault</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></code></pre></div>

<p>函数如其名，是用来打开URL的。对应着python2.x中的urllib2.urlopen函数。里面的参数可以是url，也可以是一个Request对象，Request对象会在之后介绍。</p>

<p>两种写法分别是：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&#39;http://www.baidu.com&#39;</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">request_object</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s">&#39;http://www.baidu.com&#39;</span><span class="p">)</span>
<span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request_object</span><span class="p">)</span></code></pre></div>

<p>来说一下函数原型中的各个参数：</p>

<ul>
  <li>url 这个就是你想要爬取的网络页面的url</li>
  <li>data 必须是一个 bytes 对象（这个十分重要！！！可以用encode()函数编码成bytes类型。在公司服务器调试时因为byte的问题总是获取不到数据），它指定了想要传给服务器的额外数据。如果没有的话（GET方法）就可以省略这个参数，默认值是None。data也可以是可迭代的对象（iterable object，这个和byte对象不冲突），当这种情况时，Content-Length 值就需在头（header）中指明。目前，HTTP 请求是唯一使用data的请求，如果提供了data参数，那么默认的请求类型GET就会变为POST。</li>
  <li>timeout 这个可选参数指定了超时时间，没有指定的时候就使用通用的超时时间。</li>
  <li>context （我没有用过）它必须是一个ssl.SSLContext的实例，用来描述SSL 选择的</li>
  <li>cafile and capath （我没有用过）用于指定HTTPS请求可信任的CA证书</li>
  <li>cadefault 参数可忽略</li>
</ul>

<p>调用这个函数之后会返回一个对象，可以用来操作响应内容（如果没有handler处理这个请求那么会返回None）。常用方法下面在urllib.response中会讲到。</p>

<h3 id="urllibrequestrequest">urllib.request.Request</h3>

<hr />

<p>构造函数：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{},</span> <span class="n">origin_req_host</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">unverifiable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></code></pre></div>

<p>这个类是对URL请求的抽象，实例化方法如下：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">req</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s">&#39;www.baidu.com&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="p">{},</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">)</span></code></pre></div>

<p>使用方法见urlopen函数，来说一下构造函数中的各个参数：</p>

<ul>
  <li>url 这个就是你想要爬取的网络页面的url</li>
  <li>data 必须是一个 bytes 对象（和urlopen中的data用法一样）</li>
  <li>headers 必须是一个字典</li>
  <li>origin_req_host 和 unverifable （我没有用过）可以忽略</li>
  <li>method 指定HTTP请求的方式，必须是string，比如‘GET’。如果提供了这个参数，它会储存在method属性内，可以通过get_method()方法使用。</li>
</ul>

<p>Request 对象中的公共接口：</p>

<ul>
  <li>Request.full_url： 传给构造函数的原始URL</li>
  <li>Request.type： URI scheme 统一资源标识符URI的命名结构（不是URL。具体什么是URI请看wiki <a href="https://en.wikipedia.org/wiki/Uniform_Resource_Identifier">Uniform Resource Identifier</a>）</li>
  <li>Request.host：URI authority 通常是host，也会包含由冒号分隔的端口</li>
  <li>Request.origin_req_host：请求的原始host，不包括端口</li>
  <li>Request.selector：URI path，如果请求使用代理，那么就是通过代理的url</li>
  <li>Request.data：请求的正文（body），如果没有就是None</li>
  <li>Request.method：HTTP请求的方法，例如‘GET’，‘POST’</li>
  <li>Request.get_method()：返回HTTP请求的方法，默认为‘GET’</li>
  <li>Request.add_header(key, val)：为请求添加头</li>
  <li>Request.add_unredirected_header(key, header)：为请求添加不会赋予重定向请求的头</li>
  <li>Request.has_header(header)：返回是否有名为header的头</li>
  <li>Request.remove_header(header)：移除名为header的头</li>
  <li>Request.get_full_url()：返回在构造函数中设置的URL</li>
  <li>Request.set_proxy(host, type)：为请求设置代理</li>
  <li>Request.get_header(header_name, default=None)：返回给定header的值</li>
  <li>Request.header_items()：返回头中元组的list，格式为 (header_name, header_value)</li>
</ul>

<h2 id="urllibresponse">urllib.response</h2>

<hr />

<p>官方文档链接：
<a href="https://docs.python.org/3/library/urllib.request.html#module-urllib.response">https://docs.python.org/3/library/urllib.request.html#module-urllib.response</a></p>

<p>urllib.response模块定义了操作响应的一些函数和对象。通常这些函数都是通过urllib.request 模块内部调用。</p>

<p>通过调用 urllib.request.urlopen() 函数会返回一个response对象</p>

<p>这个对像有些常用的方法（针对HTTP请求）：</p>

<ul>
  <li>geturl() 返回得到资源的url，通常用来判断是否发生重定向</li>
  <li>info() 返回页面的meta-information，例如headers</li>
  <li>read() 返回HTML页面内容</li>
  <li>getcode() 返回HTTP响应状态码</li>
</ul>

<p>使用这些方法的方式为</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></code></pre></div>

<p>或者写成</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">resp</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></code></pre></div>

<h2 id="urllibparse">urllib.parse</h2>

<hr />

<p>官方文档链接：
<a href="https://docs.python.org/3/library/urllib.parse.html">https://docs.python.org/3/library/urllib.parse.html</a></p>

<p>urllib.parse 模块定义了很多处理url的函数，可以将URL解析成不同的部分，也可以将不同的部分拼装成URL，甚至可以将相对URL在基础URL的辅助下转换成绝对URL。完整的介绍请看官网<a href="https://docs.python.org/3/library/urllib.parse.html">urllib.parse — Parse URLs into components</a>，我也只挑我用过的来说。</p>

<ul>
  <li>.encode() 函数。可以将str编码成bytes，默认ASCII编码，也可以通过赋参数改成uft－8编码：<code>.encode('utf-8')</code></li>
  <li>.decode() 函数。与encode对应，将bytes解码成str。</li>
  <li>urllib.parse.urlencode()函数。将 mapping object 或者一系列 two-element tuples转化成完全编码的ASCII text string。生成的string是一系列由‘&amp;’分隔的键值对。如果生成的string要用作POST请求的data，那么需要再编码成bytes，否则会出现TypeError错误。</li>
</ul>

<p>使用urllib.parse.urlencode()函数的例子：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">({</span><span class="s">&#39;spam&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;eggs&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;bacon&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
<span class="s">&#39;spam=1&amp;eggs=2&amp;bacon=0&#39;</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">({</span><span class="s">&#39;spam&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;eggs&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;bacon&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;http://requestb.in/xrbl82xr&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span></code></pre></div>

<h2 id="urlliberror">urllib.error</h2>

<hr />

<p>官方文档链接：
<a href="https://docs.python.org/3/library/urllib.error.html#urllib.error.URLError">https://docs.python.org/3/library/urllib.error.html#urllib.error.URLError</a></p>

<p>这个模块为由urillib.request引起的异常定义了异常类。由以下三个类：</p>

<ul>
  <li>urllib.error.URLError： handler发生异常的时候回抛出这个错误。它有一个reason属性，是描述error的string</li>
  <li>urllib.error.HTTPError：遇到外部HTTP异常的时候用它来处理。他有三个属性：code——HTTP状态码，reason——对error的描述，headers——造成error的HTTP请求的响应头。</li>
  <li>urllib.error.ContentTooShortError(msg, content)：这个没用过，官方文档解释 This exception is raised when the urlretrieve() function detects that the amount of the downloaded data is less than the expected amount (given by the Content-Length header). The content attribute stores the downloaded (and supposedly truncated) data.</li>
</ul>

<p>由于python3中<code>try …… except ……</code> 的语法改了所以大家要注意，下面提供一个例子：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">try</span><span class="p">:</span>
	<span class="n">resp</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>  
<span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
	<span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span></code></pre></div>

<h2 id="section-1">结语</h2>

<hr />

<p>这篇文章居然花了两天来写……终于写完了……长吁一口气……以后用到新的我再来更新。</p>

<p>写于2015-11-28</p>


        <footer class = "article_tag">
          
          <a id = "next_page" href = "/blog/Some-Notices-For-REGEX">
            <i class = "icon icon-hand-left"></i> 
            SOME NOTICES FOR REGEX AND PYTHON
          </a>
          
          
          <a id = "previous_page" href = "/blog/HTTP%E5%88%9D%E8%A7%A3"> 
            HTTP初解 
            <i class = "icon icon-hand-right"></i> 
          </a>
          
        </footer>
        </div>      



      <div id="disqus_thread"></div>
      <script>
              /**
              * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
              * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
              */
              /*
              var disqus_config = function () {
              this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
              this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
              };
              */
              (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');

                s.src = '//heidixiang.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
              })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            </article>

    </section>

    <section id = "blog_category">

      <p>TABLE OF CONTENTS</p>
      <div id = "toc"></div>
      <div id = "back-to-top">
        <i class = 'icon icon-circle-arrow-up'></i> 
            BACK TO TOP
      </div>
    </section>


  </div>
    



          <!-- **************************   footer  ****************************** -->
          <footer id = "pfl-footer">&copy; 2017-2018 by Xiyun Xiang. All Rights Reserved. 
            <a href = "https://github.com/xiangxiyun">
              <img class = "footlink" src = "/images/GitHub-Mark-Light-32px.png" alt = "github">
            </a>
            <a href = "https://linkedin.com/in/xiyunxiang">
              <img class = "footlink" src = "/images/Logo-White-34px-R.png" alt = "linkin">
            </a>
          </footer>
          <!-- **************************   footer  ****************************** -->


          </div> <!--/st-content-inner-->

        </div> <!--/st-content-->

      </div> <!--/st-pusher-->

    </div>   <!--/st-container -->

    <script src="/javascripts/classie.js"></script>

    <script src="/javascripts/modernizr.custom.js"></script>
    <script src="/javascripts/jquery-1.11.2.min.js"></script>
    <script src="/javascripts/jquery.easing.1.3.min.js"></script>
    <script src="/javascripts/transit.js"></script>
    <script src="/javascripts/sidebarEffects.js"></script>
    <script src="/javascripts/sidebar.js"></script>
    <script src="/javascripts/article.js"></script>
    <script src="/javascripts/techBlog.js"></script>
    <script src="/javascripts/portfolio.js"></script>
    <script src="/javascripts/lightbox.js"></script>
    <!-- javascript -->

    <!-- javascript  for  portfolio page -->
    <script type="text/javascript">
    $(document).ready(function(){ 
      $("#gallery img:not(:first-child)").hide();
      $("#index li").css("color", "rgba(0,0,0, 1)");
      $($("#index li").get(0)).css("color", "rgba(0, 0, 0, 0.5)");

      $("#index li").mouseenter(function() {
        $("#index li").css("color", "rgba(0,0,0, 1)");
        $(this).css("color", "rgba(0, 0, 0, 0.5)");
        var n = $(this).index();
        $("#gallery img").hide();
        $($("#gallery img").get(n)).fadeIn("slow");
      });

      $("#back-to-top").click(function(){
        $(".st-content").scrollTop(0);
      });



    });

</script>

  </body>
</html>